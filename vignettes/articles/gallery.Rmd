---
title: "Gallery"
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

The gallery exhibits both default plots as well as the many modifications one can make.

```{r setup}
library(ggsurvfit)
library(patchwork)
```

## Modifications with ggplot2

Let's begin with showing the default plot and common modifications that are made with ggplot2 functions.

- Expand axis to show percentages from 0% to 100%
- Limit plot to show up to 8 years of follow-up
- Add the percent sign to the y-axis label
- Reduce padding in the plot area around the curves
- Add additional tick marks on the x-axis
- Update color of the lines
- Using the ggplot2 minimal theme

```{r}
gg_default <-
  survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit() +
  add_confidence_interval() +
  labs(title = "Default")

gg_styled <-
  gg_default +
  coord_cartesian(xlim = c(0, 8)) +
  scale_y_continuous(
    limits = c(0, 1),
    labels = scales::percent, 
    expand = c(0.01, 0)
  ) +
  scale_x_continuous(breaks = 0:9, expand = c(0.02, 0)) +
  scale_color_manual(values = c('#54738E', '#82AC7C')) +
  scale_fill_manual(values = c('#54738E', '#82AC7C')) +
  theme_minimal() +
  theme(legend.position = "bottom") +
  guides(color = guide_legend(ncol = 1)) +
  labs(title = "Modified",
       y = "Percentage Survival")

gg_default + gg_styled
```

## Grey-scale Figures

You may need a black and white figure and that is achieved using grey-scale ggplot2 functions.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit() +
  add_confidence_interval() +
  scale_color_grey() +
  scale_fill_grey() +
  labs(title = "Grey Scale")
```

## Risk Tables

The default risk table styling is ready for publication.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit() +
  add_confidence_interval() +
  add_risktable()
```

You can also group the risk table by the statistics rather than the stratum.
Let's also add additional time points where the statistics are reported and extend the y axis.

```{r}
ggrisktable <-
  survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit() +
  add_confidence_interval() +
  add_risktable(risktable_group = "risktable_stats") +
  scale_x_continuous(breaks = 0:9) +
  scale_y_continuous(limits = c(0, 1))
ggrisktable
```

Use `add_risktable_strata_symbol()` to replace long stratum labels with a color symbol.
The default symbol is a colored rectangle and you can change it to any UTF-8 symbol or text string.
In the example below, we've updated the symbol to a circle.

```{r}
ggrisktable +
  add_risktable_strata_symbol(symbol = "\U25CF", size = 10)
```

You can further customize the risk table using themes and the `add_risktable(...)` arguments.
For example, use the following code to increase the font size of both the risk table text and the y-axis label.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit(size = 0.8) +
  add_risktable(
    risktable_height = 0.33,
    size = 4, # increase font size of risk table statistics
    theme =   # increase font size of risk table title and y-axis label
      list(
        theme_risktable_default(),
        theme(axis.text.y = element_text(size = 11),
              plot.title = element_text(size = 11, face = "bold"))
      )
  )
```

## KMunicate

To get figures that align with the guidelines outlined in ["Proposals on Kaplanâ€“Meier plots in medical research and a survey of stakeholder views: KMunicate."](http://dx.doi.org/10.1136/bmjopen-2019-030215), use the `theme_ggsurvfit_KMunicate()` theme along with these function options.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit(linetype_aes = TRUE) +
  add_confidence_interval() +
  add_risktable(
    risktable_stats = c("n.risk", "cum.censor", "cum.event")
  ) +
  theme_ggsurvfit_KMunicate() +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(expand = c(0.02, 0)) +
  theme(legend.position = c(0.85, 0.85))
```

## Quantiles and Censor Markings

Add guidelines for survival quantiles and markings for censored patients using `add_quantile()` and `add_censor_mark()`.
The `add_quantile()` function allows users to place guidelines by specifying either the y-intercept or x-intercept where the lines shall originate.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit(size = 0.8) +
  add_censor_mark(size = 2, alpha = 0.2) +
  add_quantile(y_value = 0.5, linetype = "dotted", color = "grey30", size = 0.8) +
  add_quantile(x_value = 5,  color = "grey30", size = 0.8) 
```

## Transformations

Show the probability of an event rather than the probability of being free from the event with transformations.
Custom transformations are also available.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit(type = "risk", size = 0.8) +
  add_confidence_interval()
```

## Side-by-Side

One of my favorite features of the {ggsurvfit} package is that any {ggplot2} function may be used to modify the plot and the risk tables will still align with the primary plot.
This is accomplished by delaying the construction of the risk tables until the plot is printed.

Because the the delayed build of the risk tables, we must take one additional step when placing figures side-by-side that contain risk tables: we must use the `ggsurvfit_build()` function when placing figures with risk tables side-by-side.
This function will construct the risk tables and combine them with the primary plot.
Once the plots are built, the can be placed side-by-side with {patchwork}.

```{r}
p <-
  survfit2(Surv(time, status) ~ 1, df_colon) %>%
  ggsurvfit() +
  add_confidence_interval() +
  add_risktable() +
  scale_y_continuous(limits = c(0, 1)) +
  scale_x_continuous(n.breaks = 7)

# build plot (which constructs the risktable)
built_p <- ggsurvfit_build(p)

# place plots side-by-side
wrap_plots(built_p, built_p, ncol = 2)
```

## Faceting

Curves created with {ggsurvfit} can also later be faceted using {ggplot2}.
Note, however, that faceted curves cannot include a risk table.

The `ggsurvfit()` function calls `tidy_survfit()` to create the data frame that is used to create the figure.
In the data frame, there is a column named `"strata"`, which we will facet over.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit() +
  add_confidence_interval() +
  facet_wrap(~strata, nrow = 1) +
  theme(legend.position = "none") +
  scale_x_continuous(n.breaks = 6) +
  labs(title = "PFS by Duration between Surgery and Treatment")
```

## Extensions

Because {ggsurvfit} functions are written as proper {ggplot2} geoms, you can both weave any {ggplot2} functions **and** ggplot2 extensions, such as {gghighlight} and {ggeasy}.

```{r warning=FALSE}
survfit2(Surv(time, status) ~ rx, data = df_colon) %>%
  ggsurvfit() +
  gghighlight::gghighlight(
    strata == "Levamisole+5-FU",
    calculate_per_facet = TRUE
  ) +
  ggeasy::easy_remove_legend() +
  ggeasy::easy_y_axis_labels_size(size = 15) +
  ggeasy::easy_x_axis_labels_size(size = 15)
```

## Scales

Unlike most {ggplot2} functions, scales are not additive.
This means that if a scale attribute is modified in one call to `scale_x_continuous()`, a second call to  `scale_x_continuous()` will write over _all_ changes made in the first.
For this reason, the `ggsurvfit()` and `ggcuminc()` functions do not modify the default {ggplot2} scales; rather, all changes to the scales are left to the user.

But, I do not like the default {ggplot2} padding when applied to survival curves: I find it to be excessive.
Moreover, I have difficulty remembering the {ggplot2} syntax to reduce the padding.
For these reasons, we export a new scale function to reduce padding for the x and y axes: `scale_continuous_reduce_pad()`.
To use this function, however, you must include all modifications you wish to make to either the x or y scale in the function call.

In the example below, we reduce the padding and make other scale changes to the scales, such as, specifying the breaks on the x-axis, increasing the y-axis limits, and show the survival probabilities on a percentage scale.

```{r}
survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit(size = 1) +
  add_confidence_interval() +
  scale_continuous_reduce_pad(
    x_scales = list(breaks = 0:9),
    y_scales = list(label = scales::percent, limits = c(0, 1))
  )
```

## P-values

Compare curves among the stratum using the `add_p()` function.
P-values can be placed either in the figure caption (the default) or in the plot area as an annotation.
Similarly to risk tables, p-values are placed on the figure at the time of printing, and therefore, you must build the figures with `ggsurvfit_build()` if you with to cobble figures together with {patchwork}.

```{r}
p <- survfit2(Surv(time, status) ~ surg, data = df_colon) %>%
  ggsurvfit()

# place p-value in caption
p1 <- p + add_pvalue(caption = "Log-rank {p.value}")

# place p-value as a plot annotation
p2 <- p + add_pvalue(location  = "annotation", x = 8.5)

ggsurvfit_build(p1) + 
  ggsurvfit_build(p2) + 
  patchwork::plot_layout(guides = "collect") &
  theme(legend.position = "bottom")
```
